<!DOCTYPE html>
<html>
<head>
    <title>Payment Processing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; }
        .payment-container { max-width: 600px; margin: 50px auto; padding: 30px; text-align: center; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status { margin: 20px 0; padding: 20px; border-radius: 10px; font-size: 16px; }
        .pending { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); color: #2d3436; border-left: 5px solid #e17055; }
        .success { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border-left: 5px solid #00b894; }
        .error { background: linear-gradient(135deg, #e17055, #d63031); color: white; border-left: 5px solid #d63031; }
        .phone-display { font-size: 18px; font-weight: bold; color: #2d3436; margin: 10px 0; }
        .amount-display { font-size: 24px; font-weight: bold; color: #00b894; margin: 15px 0; }
        .instructions { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .countdown { font-size: 20px; font-weight: bold; color: #e17055; }
        .manual-check { margin-top: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn-primary { background: #0984e3; color: white; }
        .btn-primary:hover { background: #74b9ff; }
        .test-mode { background: #fd79a8; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="payment-container">
        <h2><i class="fas fa-mobile-alt"></i> Payment Processing</h2>
        
        {% if test_mode %}
        <div class="test-mode">
            <i class="fas fa-flask"></i> <strong>TEST MODE</strong> - This is a simulation
        </div>
        {% endif %}
        
        <div class="spinner"></div>
        
        <div id="status" class="status pending">
            <div class="phone-display">
                <i class="fas fa-phone"></i> {{ phone_number }}
            </div>
            <div class="amount-display">
                <i class="fas fa-money-bill-wave"></i> KSh {{ amount }}
            </div>
            <div class="instructions">
                <p><strong>✅ Payment prompt sent successfully!</strong></p>
                <p><i class="fas fa-mobile-alt"></i> Check your phone for M-Pesa notification</p>
                <p><i class="fas fa-key"></i> Enter your M-Pesa PIN to complete payment</p>
                {% if test_mode %}
                <p><i class="fas fa-info-circle"></i> <em>Test mode: Payment will be simulated</em></p>
                {% endif %}
            </div>
        </div>
        
        <div id="countdown-container" style="display: none;">
            <p>Payment expires in: <span id="countdown" class="countdown">5:00</span></p>
        </div>
        
        <div class="manual-check">
            <button class="btn btn-primary" onclick="checkPaymentStatusNow()">
                <i class="fas fa-sync-alt"></i> Check Payment Status
            </button>
        </div>
        
        <div id="message"></div>
    </div>

    <script>
        const checkoutRequestId = '{{ checkout_request_id }}';
        const testMode = {{ test_mode|yesno:"true,false" }};
        let checkCount = 0;
        const maxChecks = 60; // Check for 5 minutes
        let countdownSeconds = 300; // 5 minutes
        let countdownInterval;

        function startCountdown() {
            document.getElementById('countdown-container').style.display = 'block';
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                document.getElementById('countdown').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    handleTimeout();
                }
                countdownSeconds--;
            }, 1000);
        }

        function checkPaymentStatus() {
            if (checkCount >= maxChecks) {
                handleTimeout();
                return;
            }

            fetch(`/check-payment-status/${checkoutRequestId}/`)
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('status');
                    
                    if (data.status === 'success') {
                        clearInterval(countdownInterval);
                        statusDiv.innerHTML = `
                            <div class="amount-display">
                                <i class="fas fa-check-circle"></i> Payment Successful!
                            </div>
                            <p><i class="fas fa-thumbs-up"></i> Your payment of KSh {{ amount }} has been confirmed</p>
                            <p><i class="fas fa-arrow-right"></i> Redirecting to order confirmation...</p>
                        `;
                        statusDiv.className = 'status success';
                        
                        // Show success notification
                        showNotification('✅ Payment completed successfully!', 'success');
                        
                        setTimeout(() => {
                            window.location.href = '/complete/';
                        }, 3000);
                    } else if (data.status === 'failed' || data.status === 'cancelled') {
                        clearInterval(countdownInterval);
                        statusDiv.innerHTML = `
                            <div class="amount-display">
                                <i class="fas fa-times-circle"></i> Payment ${data.status === 'cancelled' ? 'Cancelled' : 'Failed'}
                            </div>
                            <p><i class="fas fa-exclamation-triangle"></i> ${data.message}</p>
                            <p><a href="/checkout/" class="btn btn-primary"><i class="fas fa-redo"></i> Try Again</a></p>
                        `;
                        statusDiv.className = 'status error';
                        
                        showNotification(`❌ ${data.message}`, 'error');
                    } else {
                        // Still pending, continue checking
                        checkCount++;
                        setTimeout(checkPaymentStatus, 5000);
                        
                        // Update status message
                        if (testMode && checkCount > 2) {
                            const testMsg = document.querySelector('.instructions p:last-child');
                            if (testMsg) {
                                testMsg.innerHTML = '<i class="fas fa-hourglass-half"></i> <em>Test payment is being processed...</em>';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    checkCount++;
                    if (checkCount < maxChecks) {
                        setTimeout(checkPaymentStatus, 5000);
                    }
                });
        }

        function checkPaymentStatusNow() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            
            checkPaymentStatus();
            
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-sync-alt"></i> Check Payment Status';
            }, 2000);
        }

        function handleTimeout() {
            clearInterval(countdownInterval);
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="amount-display">
                    <i class="fas fa-clock"></i> Payment Timeout
                </div>
                <p><i class="fas fa-exclamation-triangle"></i> Payment session has expired</p>
                <p><a href="/checkout/" class="btn btn-primary"><i class="fas fa-redo"></i> Try Again</a></p>
            `;
            statusDiv.className = 'status error';
            
            showNotification('⏰ Payment timeout. Please try again.', 'warning');
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                padding: 15px 20px; border-radius: 5px; color: white;
                font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Start checking payment status and countdown
        setTimeout(() => {
            checkPaymentStatus();
            startCountdown();
        }, 2000);
        
        // Show initial confirmation
        showNotification('✅ Payment prompt sent! Check your phone.', 'success');
    </script>
</body>
</html>